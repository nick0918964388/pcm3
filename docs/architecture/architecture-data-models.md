# 資料模型與資料庫架構 (Data Models & Database Schema)

## 4. 資料模型 (Data Models)
此處定義了第一階段所需的13個核心資料模型及其 TypeScript 介面，包括：
* **使用者 (User)**: 儲存使用者基本資訊與登入憑證。
* **專案 (Project)**: 儲存營建專案的核心資訊。
* **角色 (Role)**: 定義系統中的使用者角色。
* **使用者角色關聯 (UserRole)**: 將使用者與角色進行多對多關聯。
* **協力廠商 (Subcontractor)**: 儲存協力廠商公司的基本資訊。
* **廠商人員 (Personnel)**: 儲存屬於協力廠商的個人員工資訊。
* **工作分解結構項目 (WBS_Item)**: 儲存專案的階層式 WBS。
* **WBS 變更紀錄 (WBS_Change_Log)**: 記錄對 WBS 項目的修改歷史。
* **每日報告 (Daily_Report)**: 儲存進度報告。
* **報告附件 (Report_Attachment)**: 儲存報告的附件檔案資訊。
* **公告 (Announcement)**: 儲存最新消息。
* **值班表 (Duty_Roster)**: 記錄人員值班日期。
* **出勤紀錄 (Attendance)**: 儲存刷卡機的出勤紀錄。

## 9. 資料庫結構 (Database Schema)
```sql
-- 使用者表
CREATE TABLE USERS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username VARCHAR2(255) NOT NULL UNIQUE,
    hashed_password VARCHAR2(255) NOT NULL,
    full_name NVARCHAR2(255),
    email VARCHAR2(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 專案表
CREATE TABLE PROJECTS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name NVARCHAR2(255) NOT NULL,
    code VARCHAR2(50) UNIQUE,
    status NVARCHAR2(50),
    start_date DATE,
    planned_submission_date DATE,
    total_duration_days NUMBER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 角色表
CREATE TABLE ROLES (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(255) NOT NULL UNIQUE,
    description NVARCHAR2(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 使用者角色關聯表
CREATE TABLE USER_ROLES (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id NUMBER NOT NULL,
    role_id NUMBER NOT NULL,
    project_id NUMBER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES USERS(id),
    FOREIGN KEY (role_id) REFERENCES ROLES(id),
    FOREIGN KEY (project_id) REFERENCES PROJECTS(id),
    UNIQUE(user_id, role_id, project_id)
);

-- 協力廠商表
CREATE TABLE SUBCONTRACTORS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name NVARCHAR2(255) NOT NULL,
    contact_person NVARCHAR2(255),
    phone VARCHAR2(50),
    email VARCHAR2(255),
    address NVARCHAR2(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 廠商人員表
CREATE TABLE PERSONNEL (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    subcontractor_id NUMBER NOT NULL,
    name NVARCHAR2(255) NOT NULL,
    position NVARCHAR2(255),
    phone VARCHAR2(50),
    email VARCHAR2(255),
    employee_id VARCHAR2(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (subcontractor_id) REFERENCES SUBCONTRACTORS(id)
);

-- 工作分解結構項目表
CREATE TABLE WBS_ITEMS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    project_id NUMBER NOT NULL,
    parent_id NUMBER,
    code VARCHAR2(50) NOT NULL,
    name NVARCHAR2(255) NOT NULL,
    description NVARCHAR2(1000),
    level_number NUMBER DEFAULT 1,
    sort_order NUMBER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES PROJECTS(id),
    FOREIGN KEY (parent_id) REFERENCES WBS_ITEMS(id)
);

-- WBS 變更紀錄表
CREATE TABLE WBS_CHANGE_LOGS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    wbs_item_id NUMBER NOT NULL,
    changed_by NUMBER NOT NULL,
    change_type VARCHAR2(50) NOT NULL,
    old_value CLOB,
    new_value CLOB,
    change_reason NVARCHAR2(500),
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (wbs_item_id) REFERENCES WBS_ITEMS(id),
    FOREIGN KEY (changed_by) REFERENCES USERS(id)
);

-- 每日報告表
CREATE TABLE DAILY_REPORTS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    project_id NUMBER NOT NULL,
    reported_by NUMBER NOT NULL,
    report_date DATE NOT NULL,
    content CLOB,
    weather NVARCHAR2(100),
    progress_notes CLOB,
    issues CLOB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES PROJECTS(id),
    FOREIGN KEY (reported_by) REFERENCES USERS(id)
);

-- 報告附件表
CREATE TABLE REPORT_ATTACHMENTS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    daily_report_id NUMBER NOT NULL,
    filename NVARCHAR2(255) NOT NULL,
    file_path VARCHAR2(500) NOT NULL,
    file_size NUMBER,
    mime_type VARCHAR2(100),
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (daily_report_id) REFERENCES DAILY_REPORTS(id)
);

-- 公告表
CREATE TABLE ANNOUNCEMENTS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    project_id NUMBER,
    title NVARCHAR2(255) NOT NULL,
    content CLOB NOT NULL,
    created_by NUMBER NOT NULL,
    is_active NUMBER(1) DEFAULT 1,
    priority VARCHAR2(20) DEFAULT 'normal',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES PROJECTS(id),
    FOREIGN KEY (created_by) REFERENCES USERS(id)
);

-- 值班表
CREATE TABLE DUTY_ROSTERS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    project_id NUMBER NOT NULL,
    personnel_id NUMBER NOT NULL,
    duty_date DATE NOT NULL,
    shift_type VARCHAR2(50) DEFAULT 'day',
    notes NVARCHAR2(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES PROJECTS(id),
    FOREIGN KEY (personnel_id) REFERENCES PERSONNEL(id),
    UNIQUE(project_id, personnel_id, duty_date, shift_type)
);

-- 出勤紀錄表
CREATE TABLE ATTENDANCE (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    personnel_id NUMBER NOT NULL,
    project_id NUMBER NOT NULL,
    check_in_time TIMESTAMP,
    check_out_time TIMESTAMP,
    work_date DATE NOT NULL,
    hours_worked NUMBER(4,2),
    work_type VARCHAR2(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (personnel_id) REFERENCES PERSONNEL(id),
    FOREIGN KEY (project_id) REFERENCES PROJECTS(id)
);
```