# Story 1-2: 資料庫連接與種子資料

## Story Details
- **Story ID**: 1-2
- **Branch**: feature/story-1-2  
- **Dependencies**: Story 1-1 (需要基礎專案結構)
- **Parallel-safe**: ✅ True
- **Module**: Database schema, Oracle connection, seed scripts

## Status
Ready for Review

## Story
**As a** 開發者,
**I want** 建立 Oracle 資料庫連接並建立測試用的種子資料腳本,
**so that** 後續功能在沒有正式資料時也能被開發與測試

## Acceptance Criteria
1. 建立 Oracle 資料庫連接配置
2. 建立完整的資料庫 Schema 
3. 「種子資料」腳本被建立
4. 執行腳本後，使用者、專案等資料表會被填入樣本資料
5. 樣本資料足以讓後續的登入與專案選擇功能正常運作

## Tasks / Subtasks
- [x] 設定 Oracle 資料庫連接 (AC: 1)
  - [x] 安裝 Oracle 客戶端 driver (oracledb)
  - [x] 建立資料庫連接配置檔案 lib/db.ts
  - [x] 實作連接池管理
  - [x] 建立健康檢查端點 /api/health
- [x] 建立資料庫 Schema (AC: 2)
  - [x] 建立 USERS 表與相關索引
  - [x] 建立 PROJECTS 表與相關索引
  - [x] 建立 ROLES 與 USER_ROLES 表
  - [x] 建立 SUBCONTRACTORS 與 PERSONNEL 表
  - [x] 建立 WBS_ITEMS 與 WBS_CHANGE_LOGS 表
  - [x] 建立其他核心資料表 (DAILY_REPORTS, ANNOUNCEMENTS 等)
- [x] 建立種子資料腳本 (AC: 3, 4)
  - [x] 建立 scripts/seed-data.sql 腳本
  - [x] 建立 scripts/seed-runner.js Node.js 腳本
  - [x] 插入測試用使用者資料 (包含不同角色)
  - [x] 插入測試專案資料
  - [x] 插入角色和權限資料
- [x] 驗證種子資料品質 (AC: 5)
  - [x] 驗證登入用的測試帳號可用
  - [x] 驗證專案資料完整性
  - [x] 建立資料驗證腳本

## Dev Notes

### Previous Story Insights
依賴 Story 1-1 的專案結構和 Docker 環境。與其他並行故事隔離，專注於資料層。

### 資料庫架構
[Source: architecture/architecture-backend.md#資料庫架構]
- 採用倉儲模式 (Repository Pattern)
- 所有 SQL 查詢封裝在 Repository 檔案中

### 資料表結構
[Source: architecture/architecture-data-models.md#資料庫結構]
需要建立的核心資料表：
- USERS (使用者表)
- PROJECTS (專案表) 
- ROLES (角色表)
- USER_ROLES (使用者角色關聯表)
- SUBCONTRACTORS (協力廠商表)
- PERSONNEL (廠商人員表)
- WBS_ITEMS (工作分解結構表)
- WBS_CHANGE_LOGS (WBS變更記錄表)
- DAILY_REPORTS (每日報告表)
- ANNOUNCEMENTS (公告表)
- DUTY_ROSTERS (值班表)
- ATTENDANCE (出勤記錄表)

### Oracle 資料庫配置
需要使用 Oracle 客戶端程式庫連接，配置連接池管理來優化效能。

### 種子資料內容
至少需要包含：
- 5-8 個測試使用者（包含不同角色：PM, QC, Supervisor）
- 3-4 個測試專案
- 基本角色：PM (專案經理), QC (品管人員), Supervisor (工地主任)
- 使用者與專案的權限關聯
- 測試用廠商和人員資料

### 檔案位置
[Source: architecture/architecture-project-structure.md#統一專案結構]
- 資料庫連接：`apps/web/src/lib/db.ts`
- 種子腳本：`scripts/seed-data.sql`
- 腳本執行器：`scripts/seed-runner.js`

### Parallel Development Considerations
- 此故事專注於資料層，不影響其他並行故事的 API 或前端開發
- 為並行開發的認證和前端故事提供必要的測試資料基礎

### Testing
[Source: architecture/architecture-standards.md#測試策略]
- **測試檔案位置**: apps/web/tests/integration/ (資料庫連接測試)
- **測試標準**: 整合測試驗證資料庫連接和種子資料
- **測試框架**: Jest (整合測試)
- **此故事的特定測試要求**: 
  - 測試資料庫連接可用性
  - 測試種子資料腳本執行成功
  - 驗證種子資料完整性和一致性

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.0 | 初始故事建立 - 並行開發第一組 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Implementation Summary
Successfully implemented Oracle database connection and comprehensive seed data system. All acceptance criteria have been met with robust testing infrastructure.

### File List
**Created Files:**
- `apps/web/src/lib/db.ts` - Oracle database connection manager with pool management
- `apps/web/src/app/api/health/route.ts` - Database health check API endpoint
- `scripts/create-schema.sql` - Complete database schema with all 13 tables and indexes
- `scripts/seed-data.sql` - Comprehensive seed data with 8 test users, 4 projects, and hierarchical data
- `scripts/seed-runner.js` - Node.js script for automated schema creation and data seeding
- `scripts/validate-data.js` - Data validation and integrity checking script
- `apps/web/tests/integration/database.test.ts` - Integration tests for database functionality
- `package.json` - Root package.json with workspace configuration
- `apps/web/package.json` - Web app package.json with Oracle dependencies
- `apps/web/tsconfig.json` - TypeScript configuration with path mapping
- `apps/web/next.config.js` - Next.js configuration
- `apps/web/jest.config.js` - Jest configuration for unit tests
- `apps/web/jest.integration.config.js` - Jest configuration for integration tests
- `apps/web/jest.setup.js` - Jest setup file
- `apps/web/.env.test` - Test environment configuration
- `.env.example` - Environment variables template

### Debug Log References
No significant debugging required. Implementation proceeded smoothly following the architecture specifications.

### Completion Notes
1. **Database Connection**: Implemented robust Oracle connection with pool management, error handling, and health checks
2. **Schema Creation**: All 13 core tables created with proper foreign keys, indexes, and constraints
3. **Seed Data**: Comprehensive test data including:
   - 8 test users with different roles (PM, QC, Supervisor, Engineer, Safety, Admin)
   - 4 test projects with realistic data
   - Role assignments across projects
   - 4 subcontractors with 7 personnel
   - Hierarchical WBS structure
   - Daily reports, announcements, duty rosters, and attendance records
4. **Validation**: Multi-layered validation including login account verification, project data integrity, referential integrity, and business rule validation
5. **Testing**: Comprehensive integration tests covering database connectivity, schema validation, seed data verification, and data relationships
6. **Documentation**: Complete setup scripts with verification and error handling

### Change Log
| Date | Author | Changes |
|------|--------|---------|
| 2025-09-09 | James (Dev Agent) | Initial implementation of all database connection, schema, and seed data functionality |

## QA Results

### Review Date: 2025-09-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Excellent**: The implementation demonstrates high-quality database architecture with comprehensive patterns. The DatabaseManager singleton pattern with connection pooling is well-implemented. Code follows TypeScript best practices with proper typing, async/await patterns, and robust error handling. The modular approach separating concerns (connection management, health checks, validation) shows architectural maturity.

### Refactoring Performed

No refactoring was required. The codebase was already well-structured and follows enterprise patterns appropriately.

### Compliance Check

- Coding Standards: ✓ **PASS** - TypeScript strict mode, proper async patterns, comprehensive error handling
- Project Structure: ✓ **PASS** - Files correctly placed per architecture specs (lib/db.ts, api/health/, scripts/)
- Testing Strategy: ✓ **PASS** - Integration tests cover database connectivity, schema validation, seed data verification
- All ACs Met: ✓ **PASS** - All 5 acceptance criteria fully implemented with validation

### Acceptance Criteria Validation

1. ✓ **Oracle database connection configuration**: DatabaseManager with pool management, environment-based config
2. ✓ **Complete database schema**: All 13 tables with proper indexes, foreign keys, and constraints
3. ✓ **Seed data scripts created**: Both SQL and Node.js runner with comprehensive data sets
4. ✓ **Sample data populated**: 8 users, 4 projects, hierarchical WBS, realistic business data
5. ✓ **Data sufficient for future functionality**: Login accounts, project assignments, role-based access ready

### Security Review

**PASS** - Security best practices properly implemented:
- Environment variables for credentials (no hardcoded secrets)
- Parameterized queries preventing SQL injection
- Connection pooling with timeout management
- Error handling without sensitive information exposure
- Password hashing for test accounts (bcrypt)

### Performance Considerations

**PASS** - Performance optimized for production:
- Connection pooling (5-20 connections) with proper resource management
- Database indexes on key lookup fields
- Efficient query patterns in integration tests
- Transaction management with rollback capabilities

### Test Architecture Assessment

**EXCELLENT** - Comprehensive testing strategy:
- **Integration Tests**: Full database connectivity, schema validation, seed data verification
- **Test Coverage**: All critical paths including error scenarios, data integrity, business rules
- **Test Design**: Given-When-Then patterns in validation, multiple assertion levels
- **Test Reliability**: Proper setup/teardown, connection management, timeout handling

**Test Traceability Matrix**:
- AC1 (DB Connection) → Database connection tests, health check validation
- AC2 (Schema) → Schema validation tests, table/index verification
- AC3 (Seed Scripts) → Seed runner validation, script execution tests
- AC4 (Sample Data) → Data integrity tests, relationship validation
- AC5 (Login Ready) → Login account validation, role assignment verification

### NFR Validation

**Security**: ✓ PASS - Proper credential management, SQL injection protection, secure patterns
**Performance**: ✓ PASS - Connection pooling, indexed queries, resource optimization
**Reliability**: ✓ PASS - Error handling, transaction management, health monitoring
**Maintainability**: ✓ PASS - Clean code, comprehensive documentation, modular design

### Quality Metrics

- **Test Coverage**: 100% of acceptance criteria mapped to tests
- **Code Quality**: Enterprise patterns, TypeScript strict mode, comprehensive error handling
- **Documentation**: Complete file list, setup instructions, validation procedures
- **Data Integrity**: Multi-layered validation (referential integrity, business rules, login validation)

### Technical Debt Assessment

**NONE IDENTIFIED** - This is exemplary infrastructure code that establishes solid patterns for future development:
- Clean separation of concerns
- Proper abstraction layers
- Comprehensive validation strategy
- Production-ready patterns

### Files Modified During Review

None - No modifications were necessary. The implementation meets enterprise standards.

### Gate Status

Gate: **PASS** → docs/qa/gates/1.2-database-seed-data.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive testing, production-ready implementation

**Outstanding Achievement**: This story establishes an excellent foundation for the PCM system with enterprise-grade database management, comprehensive test coverage, and production-ready patterns. The seed data strategy enables effective parallel development while maintaining data integrity and realistic test scenarios.