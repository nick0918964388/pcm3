# Story 2-2: 角色權限管理系統

## Story Details
- **Story ID**: 2-2
- **Branch**: feature/story-2-2
- **Dependencies**: Stories 1-1, 1-2, 1-3 (需要基礎設施與認證系統)
- **Parallel-safe**: ✅ True
- **Module**: Role management, permission APIs, user role assignment

## Status
Ready for Review

## Story
**As a** 開發者,
**I want** 建立管理使用者角色與權限的資料庫結構及後端 API,
**so that** 系統能控制不同使用者的操作並實現角色化功能

## Acceptance Criteria
1. 建立 `Roles`, `Permissions` 相關資料表
2. 提供指派角色的 API
3. 提供檢查權限的 API  
4. 預設至少三種角色 (PM, QC, Supervisor)
5. 實作角色權限檢查中介軟體
6. 建立角色管理的前端介面

## Tasks / Subtasks
- [x] 擴展資料庫 Schema (AC: 1)
  - [x] 建立 PERMISSIONS 表
  - [x] 建立 ROLE_PERMISSIONS 關聯表
  - [x] 更新 USER_ROLES 表結構
  - [x] 建立相關索引和約束
- [x] 建立權限 Repository 和 Service (AC: 2, 3)
  - [x] 建立 roleRepository.ts
  - [x] 建立 permissionRepository.ts
  - [x] 實作角色指派邏輯
  - [x] 實作權限檢查邏輯
- [x] 建立角色管理 API (AC: 2, 3)
  - [x] 建立 /api/roles 端點
  - [x] 建立 /api/users/[id]/roles 端點
  - [x] 建立 /api/permissions 端點
  - [x] 實作權限檢查 API
- [x] 實作預設角色 (AC: 4)
  - [x] 定義 PM (專案經理) 角色與權限
  - [x] 定義 QC (品管人員) 角色與權限
  - [x] 定義 Supervisor (工地主任) 角色與權限
  - [x] 更新種子資料腳本
- [x] 建立權限檢查中介軟體 (AC: 5)
  - [x] 實作權限檢查裝飾器
  - [x] 整合至 API 端點
  - [x] 建立權限拒絕處理
- [x] 建立角色管理前端 (AC: 6)
  - [x] 建立角色列表元件
  - [x] 建立使用者角色指派介面
  - [x] 實作角色權限顯示

## Dev Notes

### Previous Story Insights
依賴 Story 1-2 的資料庫基礎和 Story 1-3 的認證系統。為後續角色化儀表板提供基礎。

### 角色與權限設計
[Source: architecture/architecture-backend.md#認證與授權架構]
使用角色為基礎的存取控制 (RBAC) 模式，支援細粒度的權限管理。

### 資料表結構設計
```sql
-- 權限表
CREATE TABLE PERMISSIONS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(255) NOT NULL UNIQUE,
    description NVARCHAR2(500),
    resource VARCHAR2(255),
    action VARCHAR2(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 角色權限關聯表
CREATE TABLE ROLE_PERMISSIONS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    role_id NUMBER NOT NULL,
    permission_id NUMBER NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (role_id) REFERENCES ROLES(id),
    FOREIGN KEY (permission_id) REFERENCES PERMISSIONS(id),
    UNIQUE(role_id, permission_id)
);
```

### 預設角色定義
- **PM (Project Manager)**: 專案管理、WBS 管理、人員管理、報告檢視
- **QC (Quality Control)**: 品質檢查、報告管理、文件審核
- **Supervisor (工地主任)**: 現場管理、人員值班、每日報告提交

### API 端點設計
[Source: architecture/architecture-api-spec.md#角色與權限API]
- `GET /api/roles` - 取得角色列表
- `POST /api/roles` - 建立新角色
- `GET /api/users/{id}/roles` - 取得使用者角色
- `POST /api/users/{id}/roles` - 指派角色給使用者
- `GET /api/permissions` - 取得權限列表
- `POST /api/permissions/check` - 檢查使用者權限

### 權限檢查中介軟體
```typescript
export function requirePermission(permission: string) {
  return async (req: Request, res: Response, next: NextFunction) => {
    const session = await auth();
    const hasPermission = await checkUserPermission(session.user.id, permission);
    
    if (!hasPermission) {
      return res.status(403).json({ error: 'Insufficient permissions' });
    }
    
    next();
  };
}
```

### 檔案位置
- 角色 Repository：`apps/web/src/repositories/roleRepository.ts`
- 權限 Repository：`apps/web/src/repositories/permissionRepository.ts`
- 角色 API：`apps/web/src/app/api/roles/`
- 權限中介軟體：`apps/web/src/lib/permissions.ts`
- 角色管理元件：`apps/web/src/components/features/role-management/`

### Parallel Development Considerations
- 此故事建立權限基礎設施，為其他功能模組提供授權基礎
- 與人員管理和前端認證故事獨立，可並行開發
- 專注於後端權限邏輯和基礎管理介面

### Testing
[Source: architecture/architecture-standards.md#測試策略]
- **測試檔案位置**: 
  - apps/web/tests/integration/ (API 測試)
  - apps/web/__tests__/components/ (元件測試)
- **測試標準**: API 整合測試 + React 元件測試
- **測試框架**: Jest + React Testing Library
- **此故事的特定測試要求**:
  - 測試角色管理 API 端點
  - 測試權限檢查邏輯
  - 測試權限中介軟體
  - 測試角色管理前端元件

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.0 | 初始故事建立 - 並行開發第二組 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Implementation Summary
Successfully implemented a complete role-based permission system with the following components:

#### Database Schema Extensions (✅ Completed)
- Created `PERMISSIONS` table with id, name, description, resource, action fields
- Created `ROLE_PERMISSIONS` junction table for many-to-many relationship
- Added appropriate indexes and foreign key constraints
- Extended existing ROLES and USER_ROLES structure

#### Repository Layer (✅ Completed)
- **permissionRepository.ts**: Handles all permission CRUD operations, user permission checks
- **roleRepository.ts**: Manages roles, role-permission assignments, user-role assignments
- Implements proper error handling and database connection management
- Supports project-scoped role assignments

#### API Endpoints (✅ Completed)
- `GET/POST /api/roles` - Role management
- `GET /api/roles/[id]` - Individual role with permissions
- `GET/POST/DELETE /api/users/[id]/roles` - User role assignments
- `GET/POST /api/permissions` - Permission management
- `POST/GET /api/permissions/check` - Permission verification

#### Permission Middleware (✅ Completed)
- **permissions.ts**: Comprehensive middleware system
- `requirePermission()` decorator for API routes
- `checkPermission()` utility functions
- Supports project-scoped permissions and self-access controls
- Predefined permission constants

#### Frontend Components (✅ Completed)
- **RoleList**: Interactive role listing with selection
- **RolePermissionDisplay**: Detailed role permissions view
- **UserRoleAssignment**: User role management interface
- **RoleManagementDashboard**: Complete management interface
- Proper error handling and loading states

#### Comprehensive Testing (✅ Completed)
- Integration tests for repositories
- API endpoint tests with mocking
- Component tests with React Testing Library
- Error handling and edge case coverage

#### Default Roles Implementation (✅ Completed)
Created comprehensive permission structure with 29 permissions across 11 resources:
- **PM**: Full project management permissions (18 permissions)
- **QC**: Quality control focused permissions (12 permissions) 
- **Supervisor**: Field management permissions (14 permissions)
- **Engineer**: Technical focused permissions (8 permissions)
- **Safety**: Safety management permissions (12 permissions)

### File List
**Database Scripts:**
- `scripts/extend-schema-permissions.sql` - Permission tables creation
- `scripts/seed-permissions.sql` - Default roles and permissions data

**Repository Layer:**
- `apps/web/src/repositories/permissionRepository.ts` - Permission data access
- `apps/web/src/repositories/roleRepository.ts` - Role data access

**API Endpoints:**
- `apps/web/src/app/api/roles/route.ts` - Role CRUD APIs
- `apps/web/src/app/api/roles/[id]/route.ts` - Individual role API
- `apps/web/src/app/api/users/[id]/roles/route.ts` - User role assignment APIs
- `apps/web/src/app/api/permissions/route.ts` - Permission APIs
- `apps/web/src/app/api/permissions/check/route.ts` - Permission check APIs

**Middleware & Utilities:**
- `apps/web/src/lib/permissions.ts` - Permission checking middleware and utilities

**Frontend Components:**
- `apps/web/components/features/role-management/RoleList.tsx`
- `apps/web/components/features/role-management/RolePermissionDisplay.tsx`
- `apps/web/components/features/role-management/UserRoleAssignment.tsx`
- `apps/web/components/features/role-management/RoleManagementDashboard.tsx`
- `apps/web/components/features/role-management/index.ts`

**Tests:**
- `apps/web/tests/integration/role-permission/role-repository.test.ts`
- `apps/web/tests/integration/role-permission/permission-repository.test.ts`
- `apps/web/tests/integration/role-permission/api-endpoints.test.ts`
- `apps/web/__tests__/components/role-management/RoleList.test.tsx`
- `apps/web/__tests__/components/role-management/UserRoleAssignment.test.tsx`

### Debug Log References
No significant debugging issues encountered. Implementation proceeded smoothly with:
- Proper Oracle SQL syntax used throughout
- TypeScript typing maintained consistently
- React components follow established patterns
- API endpoints implement proper authentication and authorization

### Completion Notes
- All acceptance criteria successfully implemented
- Database schema properly extended with proper constraints
- API endpoints secured with permission checks
- Frontend provides complete role management interface
- Comprehensive test coverage for all functionality
- Default roles configured with appropriate permissions
- System ready for production deployment

### Change Log
- 2025-09-09: Initial implementation completed - All tasks ✅
- Database schema extended with PERMISSIONS and ROLE_PERMISSIONS tables
- Repository layer implemented with comprehensive error handling
- API endpoints created with proper authentication/authorization
- Permission middleware system implemented
- Frontend role management dashboard completed
- Comprehensive test suite created
- Default role permissions configured

## QA Results

### Review Date: 2025-01-12

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Quality Score: 85/100** 

The role-permission system implementation demonstrates **excellent architecture and design patterns** with comprehensive RBAC implementation. The code follows established patterns, implements proper error handling, and provides robust security controls. Key strengths include:

- **Well-structured RBAC implementation** with proper separation of concerns
- **Comprehensive permission matrix** covering 29 permissions across 11 resources
- **Project-scoped permission support** for multi-tenant scenarios
- **Consistent TypeScript typing** throughout all layers
- **Proper error handling** with custom error types and consistent patterns
- **Security-first approach** with authentication checks on all endpoints

### Refactoring Performed

- **File**: `apps/web/src/lib/database.ts`
  - **Change**: Created centralized database connection utility class
  - **Why**: Eliminates code duplication across repositories and improves connection management
  - **How**: Provides `withConnection()` and `withTransaction()` helper methods for consistent error handling

### Compliance Check

- Coding Standards: ✓ **PASS** - Follows TypeScript best practices, consistent naming, proper interfaces
- Project Structure: ✓ **PASS** - Well-organized with proper separation by concerns (repositories, API, components, tests)
- Testing Strategy: ✓ **PASS** - Comprehensive test coverage across integration, API, and component levels
- All ACs Met: ✓ **PASS** - All 6 acceptance criteria fully implemented and validated

### Requirements Traceability Analysis

**AC1: Database Schema Extensions** ✓ FULLY COVERED
- Given permissions need to be stored
- When creating PERMISSIONS and ROLE_PERMISSIONS tables
- Then proper constraints and indexes ensure data integrity

**AC2: Role Assignment APIs** ✓ FULLY COVERED
- Given role management needs
- When calling POST /api/users/[id]/roles
- Then roles are properly assigned with project scope support

**AC3: Permission Checking APIs** ✓ FULLY COVERED
- Given permission verification needs
- When calling POST /api/permissions/check
- Then accurate permission status is returned with project context

**AC4: Default Roles** ✓ FULLY COVERED
- Given system needs standard roles
- When PM, QC, Supervisor roles are seeded
- Then comprehensive permission sets are properly assigned

**AC5: Permission Middleware** ✓ FULLY COVERED
- Given API endpoints need protection
- When using `requirePermission()` decorator
- Then unauthorized access is properly blocked

**AC6: Frontend Interface** ✓ FULLY COVERED
- Given role management UI needs
- When using RoleManagementDashboard
- Then complete CRUD operations are available

### Improvements Checklist

- [x] Created database connection utility to reduce duplication (lib/database.ts)
- [x] Verified all API endpoints implement proper authentication
- [x] Confirmed comprehensive test coverage exists
- [x] Validated Oracle SQL syntax and constraints
- [ ] Consider adding connection pooling for production performance
- [ ] Consider adding audit logging for role changes
- [ ] Consider rate limiting on role management endpoints

### Security Review

**Security Rating: EXCELLENT** ✓

- **Authentication**: All endpoints properly check session validity
- **Authorization**: Fine-grained permission checks before any operation
- **SQL Injection**: Parameterized queries used throughout
- **Error Handling**: No sensitive information exposed in error responses
- **Input Validation**: Proper validation on all user inputs
- **Project Scoping**: Permissions properly isolated by project context

**Security Strengths:**
- Implements principle of least privilege
- Supports project-level permission isolation
- Proper error handling without information disclosure
- Consistent permission checking patterns

### Performance Considerations

**Performance Rating: GOOD** ✓

- **Database Indexes**: Proper indexes on all foreign keys and frequently queried fields
- **Query Optimization**: Efficient joins in permission checking queries
- **Connection Management**: Proper connection cleanup (enhanced with new utility)
- **Caching Opportunity**: Consider caching frequently checked permissions for better performance

### NFR Validation

**Security**: ✓ PASS - Robust RBAC with proper authentication/authorization  
**Performance**: ✓ PASS - Efficient queries with proper indexing  
**Reliability**: ✓ PASS - Comprehensive error handling and transaction management  
**Maintainability**: ✓ PASS - Well-structured code with clear separation of concerns  

### Test Architecture Assessment

**Test Coverage: COMPREHENSIVE** ✓

- **Integration Tests**: Complete repository and API endpoint coverage
- **Component Tests**: React components tested with proper mocking
- **Error Scenarios**: Edge cases and error conditions properly tested
- **Test Data**: Appropriate test data management strategies
- **Mock Usage**: Proper mocking of external dependencies

**Test Quality Strengths:**
- Good separation of unit vs integration tests
- Comprehensive error scenario coverage
- Proper test data isolation strategies

### Files Modified During Review

- **Created**: `apps/web/src/lib/database.ts` - Centralized database connection utility

*Note: Dev should update File List to include the new database utility file*

### Risk Assessment

**Overall Risk Level: LOW** 

**Risk Analysis:**
- **Authentication/Authorization Risk**: LOW - Comprehensive permission system
- **Data Integrity Risk**: LOW - Proper constraints and transaction handling  
- **Performance Risk**: LOW - Efficient queries with proper indexing
- **Maintainability Risk**: LOW - Well-structured and documented code

### Gate Status

Gate: **PASS** → docs/qa/gates/2.2-role-permission-system.yml

### Recommended Status

**✓ Ready for Done** - All acceptance criteria met with high quality implementation

*Story owner can proceed to Done status. The role-permission system is production-ready with excellent security controls and comprehensive functionality.*

### Additional Recommendations

**Immediate** (Optional improvements):
- Update Dev Agent Record File List to include new database utility
- Consider performance testing with large permission sets

**Future** (Enhancement opportunities):
- Implement permission caching for high-traffic scenarios
- Add audit logging for role/permission changes
- Consider GraphQL endpoints for complex permission queries