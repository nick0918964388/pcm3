# Story 2-2: 角色權限管理系統

## Story Details
- **Story ID**: 2-2
- **Branch**: feature/story-2-2
- **Dependencies**: Stories 1-1, 1-2, 1-3 (需要基礎設施與認證系統)
- **Parallel-safe**: ✅ True
- **Module**: Role management, permission APIs, user role assignment

## Status
Draft

## Story
**As a** 開發者,
**I want** 建立管理使用者角色與權限的資料庫結構及後端 API,
**so that** 系統能控制不同使用者的操作並實現角色化功能

## Acceptance Criteria
1. 建立 `Roles`, `Permissions` 相關資料表
2. 提供指派角色的 API
3. 提供檢查權限的 API  
4. 預設至少三種角色 (PM, QC, Supervisor)
5. 實作角色權限檢查中介軟體
6. 建立角色管理的前端介面

## Tasks / Subtasks
- [ ] 擴展資料庫 Schema (AC: 1)
  - [ ] 建立 PERMISSIONS 表
  - [ ] 建立 ROLE_PERMISSIONS 關聯表
  - [ ] 更新 USER_ROLES 表結構
  - [ ] 建立相關索引和約束
- [ ] 建立權限 Repository 和 Service (AC: 2, 3)
  - [ ] 建立 roleRepository.ts
  - [ ] 建立 permissionRepository.ts
  - [ ] 實作角色指派邏輯
  - [ ] 實作權限檢查邏輯
- [ ] 建立角色管理 API (AC: 2, 3)
  - [ ] 建立 /api/roles 端點
  - [ ] 建立 /api/users/[id]/roles 端點
  - [ ] 建立 /api/permissions 端點
  - [ ] 實作權限檢查 API
- [ ] 實作預設角色 (AC: 4)
  - [ ] 定義 PM (專案經理) 角色與權限
  - [ ] 定義 QC (品管人員) 角色與權限
  - [ ] 定義 Supervisor (工地主任) 角色與權限
  - [ ] 更新種子資料腳本
- [ ] 建立權限檢查中介軟體 (AC: 5)
  - [ ] 實作權限檢查裝飾器
  - [ ] 整合至 API 端點
  - [ ] 建立權限拒絕處理
- [ ] 建立角色管理前端 (AC: 6)
  - [ ] 建立角色列表元件
  - [ ] 建立使用者角色指派介面
  - [ ] 實作角色權限顯示

## Dev Notes

### Previous Story Insights
依賴 Story 1-2 的資料庫基礎和 Story 1-3 的認證系統。為後續角色化儀表板提供基礎。

### 角色與權限設計
[Source: architecture/architecture-backend.md#認證與授權架構]
使用角色為基礎的存取控制 (RBAC) 模式，支援細粒度的權限管理。

### 資料表結構設計
```sql
-- 權限表
CREATE TABLE PERMISSIONS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(255) NOT NULL UNIQUE,
    description NVARCHAR2(500),
    resource VARCHAR2(255),
    action VARCHAR2(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 角色權限關聯表
CREATE TABLE ROLE_PERMISSIONS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    role_id NUMBER NOT NULL,
    permission_id NUMBER NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (role_id) REFERENCES ROLES(id),
    FOREIGN KEY (permission_id) REFERENCES PERMISSIONS(id),
    UNIQUE(role_id, permission_id)
);
```

### 預設角色定義
- **PM (Project Manager)**: 專案管理、WBS 管理、人員管理、報告檢視
- **QC (Quality Control)**: 品質檢查、報告管理、文件審核
- **Supervisor (工地主任)**: 現場管理、人員值班、每日報告提交

### API 端點設計
[Source: architecture/architecture-api-spec.md#角色與權限API]
- `GET /api/roles` - 取得角色列表
- `POST /api/roles` - 建立新角色
- `GET /api/users/{id}/roles` - 取得使用者角色
- `POST /api/users/{id}/roles` - 指派角色給使用者
- `GET /api/permissions` - 取得權限列表
- `POST /api/permissions/check` - 檢查使用者權限

### 權限檢查中介軟體
```typescript
export function requirePermission(permission: string) {
  return async (req: Request, res: Response, next: NextFunction) => {
    const session = await auth();
    const hasPermission = await checkUserPermission(session.user.id, permission);
    
    if (!hasPermission) {
      return res.status(403).json({ error: 'Insufficient permissions' });
    }
    
    next();
  };
}
```

### 檔案位置
- 角色 Repository：`apps/web/src/repositories/roleRepository.ts`
- 權限 Repository：`apps/web/src/repositories/permissionRepository.ts`
- 角色 API：`apps/web/src/app/api/roles/`
- 權限中介軟體：`apps/web/src/lib/permissions.ts`
- 角色管理元件：`apps/web/src/components/features/role-management/`

### Parallel Development Considerations
- 此故事建立權限基礎設施，為其他功能模組提供授權基礎
- 與人員管理和前端認證故事獨立，可並行開發
- 專注於後端權限邏輯和基礎管理介面

### Testing
[Source: architecture/architecture-standards.md#測試策略]
- **測試檔案位置**: 
  - apps/web/tests/integration/ (API 測試)
  - apps/web/__tests__/components/ (元件測試)
- **測試標準**: API 整合測試 + React 元件測試
- **測試框架**: Jest + React Testing Library
- **此故事的特定測試要求**:
  - 測試角色管理 API 端點
  - 測試權限檢查邏輯
  - 測試權限中介軟體
  - 測試角色管理前端元件

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.0 | 初始故事建立 - 並行開發第二組 | Bob (Scrum Master) |

## Dev Agent Record
_This section will be populated by the development agent during implementation_

## QA Results
_Results from QA Agent review will be populated here after implementation_