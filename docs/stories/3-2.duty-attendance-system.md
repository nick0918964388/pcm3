# Story 3-2: 值班表與出勤系統

## Story Details
- **Story ID**: 3-2
- **Branch**: feature/story-3-2
- **Dependencies**: Stories 2-1, 2-2, 2-3 (需要認證系統與人員資料)
- **Parallel-safe**: ✅ True
- **Module**: Calendar interface, duty scheduling, attendance tracking

## Status
Draft

## Story
**As a** 專案經理,
**I want** 一個日曆介面來管理人員值班表並接收出勤數據,
**so that** 我能隨時知道誰在值班並統計工時資料

## Acceptance Criteria
1. 提供含日曆元件的值班表頁面
2. 可從通訊錄選擇人員並指派到日期
3. 日曆上清晰顯示值班人員
4. 資料儲存至資料庫
5. 建立安全的 API 端點來接收出勤數據
6. 產生出勤統計報表與圖表
7. 支援不同班別管理 (日班/夜班)

## Tasks / Subtasks
- [ ] 建立值班表 API (AC: 2, 4)
  - [ ] 建立 dutyRosterRepository.ts
  - [ ] 建立 /api/duty-rosters 端點
  - [ ] 實作值班排程 CRUD 操作
  - [ ] 實作人員值班衝突檢查
- [ ] 建立出勤數據 API (AC: 5)
  - [ ] 建立 attendanceRepository.ts
  - [ ] 建立 /api/attendance 端點 (POST)
  - [ ] 實作安全認證機制
  - [ ] 實作資料驗證邏輯
- [ ] 建立日曆值班表前端 (AC: 1, 3)
  - [ ] 整合日曆元件庫 (如 FullCalendar)
  - [ ] 建立值班表顯示元件
  - [ ] 實作日期範圍選擇
  - [ ] 建立值班人員快速指派介面
- [ ] 實作人員指派功能 (AC: 2)
  - [ ] 建立人員選擇下拉選單
  - [ ] 實作多人值班支援
  - [ ] 建立值班班別選擇
  - [ ] 實作值班註記功能
- [ ] 建立出勤統計功能 (AC: 6)
  - [ ] 實作出勤數據查詢 API
  - [ ] 建立出勤統計計算邏輯
  - [ ] 實作圖表顯示 (如 Chart.js)
  - [ ] 建立統計報表匯出
- [ ] 實作班別管理 (AC: 7)
  - [ ] 建立班別設定介面
  - [ ] 實作班別時間範圍設定
  - [ ] 支援自訂班別類型
  - [ ] 建立班別顏色標示

## Dev Notes

### Previous Story Insights
依賴 Story 2-3 的人員資料，需要從人員通訊錄選擇值班人員。使用 Story 2-2 的權限系統控制存取。

### 值班表資料模型
[Source: architecture/architecture-data-models.md#資料庫結構]
```sql
CREATE TABLE DUTY_ROSTERS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    project_id NUMBER NOT NULL,
    personnel_id NUMBER NOT NULL,
    duty_date DATE NOT NULL,
    shift_type VARCHAR2(50) DEFAULT 'day',
    notes NVARCHAR2(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES PROJECTS(id),
    FOREIGN KEY (personnel_id) REFERENCES PERSONNEL(id),
    UNIQUE(project_id, personnel_id, duty_date, shift_type)
);
```

### 出勤記錄資料模型
```sql
CREATE TABLE ATTENDANCE (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    personnel_id NUMBER NOT NULL,
    project_id NUMBER NOT NULL,
    check_in_time TIMESTAMP,
    check_out_time TIMESTAMP,
    work_date DATE NOT NULL,
    hours_worked NUMBER(4,2),
    work_type VARCHAR2(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (personnel_id) REFERENCES PERSONNEL(id),
    FOREIGN KEY (project_id) REFERENCES PROJECTS(id)
);
```

### API 端點設計
[Source: architecture/architecture-api-spec.md#值班表API]
- `GET /api/duty-rosters` - 取得值班表
- `POST /api/duty-rosters` - 建立值班安排
- `PUT /api/duty-rosters/{id}` - 更新值班安排
- `DELETE /api/duty-rosters/{id}` - 刪除值班安排
- `POST /api/attendance` - 接收出勤數據
- `GET /api/attendance/reports` - 產生出勤統計報表

### 日曆元件整合
使用 FullCalendar 或類似日曆庫：
```typescript
interface DutyCalendarProps {
  dutyRosters: DutyRoster[];
  onDateSelect: (date: Date) => void;
  onEventClick: (roster: DutyRoster) => void;
}

const DutyCalendar: React.FC<DutyCalendarProps> = ({ dutyRosters }) => {
  // 日曆事件渲染邏輯
};
```

### 出勤數據 API 安全性
[Source: architecture/architecture-standards.md#API安全性]
- API 金鑰認證
- 資料格式驗證
- 重複資料檢查
- 異常數據處理

### 統計報表功能
- 每日出勤統計
- 按機能分類統計 (土建/機電)
- 工時趨勢圖表
- 出勤率分析
- 異常出勤提醒

### 班別管理設計
- 日班 (8:00-17:00)
- 夜班 (20:00-05:00)
- 自訂班別支援
- 班別顏色標示
- 班別交接記錄

### 檔案位置
- 值班表 Repository：`apps/web/src/repositories/dutyRosterRepository.ts`
- 出勤 Repository：`apps/web/src/repositories/attendanceRepository.ts`
- 值班表 API：`apps/web/src/app/api/duty-rosters/`
- 出勤 API：`apps/web/src/app/api/attendance/`
- 日曆頁面：`apps/web/src/app/(main)/[projectId]/duty-roster/`
- 日曆元件：`apps/web/src/components/features/duty-roster/`

### Parallel Development Considerations
- 此故事專注於排程和出勤功能，與其他業務邏輯模組獨立
- 使用人員資料但不修改人員管理邏輯
- 為後續報告和儀表板提供出勤數據

### Testing
[Source: architecture/architecture-standards.md#測試策略]
- **測試檔案位置**: 
  - apps/web/tests/integration/ (API 測試)
  - apps/web/__tests__/components/ (元件測試)
- **測試標準**: API 整合測試 + React 元件測試
- **測試框架**: Jest + React Testing Library
- **此故事的特定測試要求**:
  - 測試值班表 API 端點
  - 測試出勤數據接收 API
  - 測試日曆元件功能
  - 測試統計報表生成

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.0 | 初始故事建立 - 並行開發第三組 | Bob (Scrum Master) |

## Dev Agent Record
_This section will be populated by the development agent during implementation_

## QA Results
_Results from QA Agent review will be populated here after implementation_