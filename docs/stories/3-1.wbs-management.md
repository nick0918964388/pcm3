# Story 3-1: WBS 工作分解管理系統

## Story Details
- **Story ID**: 3-1
- **Branch**: feature/story-3-1
- **Dependencies**: Stories 2-1, 2-2, 2-3 (需要認證系統與權限管理)
- **Parallel-safe**: ✅ True
- **Module**: WBS hierarchical management, change tracking, audit logging

## Status
Draft

## Story
**As a** 專案經理,
**I want** 一個介面來管理專案的 WBS 工作分解結構,
**so that** 我能定義完整的專案範疇並追蹤所有變更

## Acceptance Criteria
1. 提供 WBS 管理頁面
2. 可新增、編輯、刪除階層式 WBS 項目
3. 支援拖拉排序
4. 所有對已儲存項目的修改都會被記錄在 audit log 中
5. 後端 API 支援以上操作
6. 支援 WBS 項目的收闔與展開顯示
7. 提供 WBS 匯出功能

## Tasks / Subtasks
- [ ] 建立 WBS 資料模型和 API (AC: 5)
  - [ ] 建立 wbsRepository.ts
  - [ ] 建立 /api/wbs/{projectId} 端點
  - [ ] 實作階層式 CRUD 操作
  - [ ] 實作拖拉排序 API
- [ ] 實作 WBS 變更追蹤 (AC: 4)
  - [ ] 建立 wbsChangeLogRepository.ts
  - [ ] 實作變更記錄邏輯
  - [ ] 建立 audit log API 端點
  - [ ] 實作變更比較功能
- [ ] 建立 WBS 管理前端 (AC: 1, 2, 6)
  - [ ] 建立 WBS 樹狀結構元件
  - [ ] 實作新增/編輯 WBS 項目表單
  - [ ] 實作階層式顯示邏輯
  - [ ] 實作收闔與展開功能
- [ ] 實作拖拉排序功能 (AC: 3)
  - [ ] 整合拖拉排序函式庫
  - [ ] 實作前端拖拉邏輯
  - [ ] 處理階層變更邏輯
  - [ ] 即時更新排序
- [ ] 建立 WBS 輔助功能 (AC: 7)
  - [ ] 實作 WBS 匯出功能 (Excel/PDF)
  - [ ] 建立 WBS 範本功能
  - [ ] 實作 WBS 複製功能
  - [ ] 建立變更歷史查看介面

## Dev Notes

### Previous Story Insights
依賴 Story 2-2 的權限系統進行存取控制。需要 PM 角色權限才能管理 WBS。

### WBS 資料模型
[Source: architecture/architecture-data-models.md#資料庫結構]
```sql
CREATE TABLE WBS_ITEMS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    project_id NUMBER NOT NULL,
    parent_id NUMBER,
    code VARCHAR2(50) NOT NULL,
    name NVARCHAR2(255) NOT NULL,
    description NVARCHAR2(1000),
    level_number NUMBER DEFAULT 1,
    sort_order NUMBER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES PROJECTS(id),
    FOREIGN KEY (parent_id) REFERENCES WBS_ITEMS(id)
);
```

### WBS 變更記錄模型
```sql
CREATE TABLE WBS_CHANGE_LOGS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    wbs_item_id NUMBER NOT NULL,
    changed_by NUMBER NOT NULL,
    change_type VARCHAR2(50) NOT NULL,
    old_value CLOB,
    new_value CLOB,
    change_reason NVARCHAR2(500),
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (wbs_item_id) REFERENCES WBS_ITEMS(id),
    FOREIGN KEY (changed_by) REFERENCES USERS(id)
);
```

### API 端點設計
[Source: architecture/architecture-api-spec.md#WBS API]
- `GET /api/wbs/{projectId}` - 取得專案 WBS 結構
- `POST /api/wbs/{projectId}/items` - 新增 WBS 項目
- `PUT /api/wbs/items/{id}` - 更新 WBS 項目
- `DELETE /api/wbs/items/{id}` - 刪除 WBS 項目
- `POST /api/wbs/items/{id}/reorder` - 重新排序 WBS
- `GET /api/wbs/items/{id}/changes` - 取得變更記錄

### 前端 WBS 樹狀結構
使用遞迴元件實作階層式顯示：
```typescript
interface WBSTreeProps {
  items: WBSItem[];
  parentId?: number;
  level?: number;
  onEdit: (item: WBSItem) => void;
  onDelete: (id: number) => void;
}

const WBSTree: React.FC<WBSTreeProps> = ({ items, parentId, level = 0 }) => {
  // 遞迴渲染邏輯
};
```

### 拖拉排序實作
使用 `@dnd-kit/sortable` 實作拖拉排序：
- 支援同層級項目排序
- 支援跨層級移動
- 即時更新資料庫

### 變更追蹤機制
- 記錄所有 WBS 項目的變更
- 追蹤變更者和變更時間
- 提供變更原因輸入
- 支援變更歷史查看

### 檔案位置
- WBS Repository：`apps/web/src/repositories/wbsRepository.ts`
- 變更記錄 Repository：`apps/web/src/repositories/wbsChangeLogRepository.ts`
- WBS API：`apps/web/src/app/api/wbs/`
- WBS 管理頁面：`apps/web/src/app/(main)/[projectId]/wbs/`
- WBS 元件：`apps/web/src/components/features/wbs/`

### Parallel Development Considerations
- 此故事專注於 WBS 功能，與其他業務邏輯模組獨立
- 使用標準 API 模式，與其他並行故事不衝突
- 為後續專案管理功能提供 WBS 基礎

### Testing
[Source: architecture/architecture-standards.md#測試策略]
- **測試檔案位置**: 
  - apps/web/tests/integration/ (API 測試)
  - apps/web/__tests__/components/ (元件測試)
- **測試標準**: API 整合測試 + React 元件測試
- **測試框架**: Jest + React Testing Library
- **此故事的特定測試要求**:
  - 測試 WBS CRUD API 端點
  - 測試階層式資料邏輯
  - 測試拖拉排序功能
  - 測試變更追蹤機制

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.0 | 初始故事建立 - 並行開發第三組 | Bob (Scrum Master) |

## Dev Agent Record
_This section will be populated by the development agent during implementation_

## QA Results
_Results from QA Agent review will be populated here after implementation_