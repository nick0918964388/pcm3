# Story 1-3: 認證後端 API 系統

## Story Details
- **Story ID**: 1-3
- **Branch**: feature/story-1-3
- **Dependencies**: Stories 1-1, 1-2 (需要專案結構與資料庫)
- **Parallel-safe**: ✅ True  
- **Module**: NextAuth.js setup, user repository, auth APIs

## Status
Ready for Review

## Story
**As a** 系統開發者,
**I want** 實作使用者認證的後端 API 系統,
**so that** 前端可以安全地進行使用者驗證和會話管理

## Acceptance Criteria
1. 實作 NextAuth.js 認證配置
2. 建立使用者驗證的 API 端點
3. 根據 Oracle 中的資料核對憑證  
4. 成功登入後建立安全會話
5. 提供會話檢查和登出功能
6. 實作適當的錯誤處理和安全性措施

## Tasks / Subtasks
- [x] 設定 NextAuth.js 配置 (AC: 1)
  - [x] 安裝 NextAuth.js 5.x
  - [x] 建立 auth.ts 配置檔案
  - [x] 配置 Credentials Provider
  - [x] 設定會話策略和 JWT callbacks
- [x] 實作使用者 Repository (AC: 3)
  - [x] 建立 userRepository.ts
  - [x] 實作 findByUsername 方法
  - [x] 實作密碼驗證邏輯 (bcrypt)
  - [x] 實作角色查詢功能
- [x] 建立認證 API 端點 (AC: 2, 4, 5)
  - [x] 建立 [...nextauth]/route.ts
  - [x] 實作登入驗證邏輯
  - [x] 實作會話管理
  - [x] 建立 /api/auth/session 端點
- [x] 實作安全性措施 (AC: 6)
  - [x] 密碼雜湊驗證 (bcrypt)
  - [x] 錯誤訊息標準化
  - [x] 會話安全配置 (HTTPOnly, Secure, SameSite)
  - [x] API 端點安全性檢查

## Dev Notes

### Previous Story Insights
依賴 Story 1-1 的專案結構和 Story 1-2 的資料庫連接與種子資料。與前端認證故事完全隔離，可並行開發。

### 認證架構
[Source: architecture/architecture-backend.md#認證與授權架構]
使用 NextAuth.js 處理認證，並透過 Callbacks 將使用者角色資訊注入 Session Token。

### NextAuth.js 配置範例
[Source: architecture/architecture-backend.md#認證與授權架構]
```typescript
export const { handlers, auth, signIn, signOut } = NextAuth({
  providers: [
    CredentialsProvider({
      name: 'credentials',
      credentials: {
        username: { label: 'Username', type: 'text' },
        password: { label: 'Password', type: 'password' }
      },
      async authorize(credentials) {
        // 實作認證邏輯
      }
    })
  ],
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.username = user.username;
      }
      return token;
    },
    async session({ session, token }) {
      if (token) {
        session.user.id = token.sub;
        session.user.username = token.username;
      }
      return session;
    }
  }
});
```

### 使用者資料模型
[Source: architecture/architecture-data-models.md#資料庫結構]
USERS 表結構：
- id: NUMBER (主鍵)
- username: VARCHAR2(255) UNIQUE
- hashed_password: VARCHAR2(255)
- full_name: NVARCHAR2(255)
- email: VARCHAR2(255)
- created_at: TIMESTAMP

### Repository 模式實作
[Source: architecture/architecture-backend.md#資料存取層]
```typescript
export const userRepository = {
  async findByUsername(username: string): Promise<User | null> {
    // SQL 查詢實作
  },
  async validatePassword(plainPassword: string, hashedPassword: string): Promise<boolean> {
    // bcrypt 驗證
  }
};
```

### 安全性要求
[Source: architecture/architecture-standards.md#安全性需求]
- 使用 bcrypt 雜湊密碼，加鹽強度至少 10
- 使用 HTTPOnly、Secure、SameSite 屬性的 Session
- 統一錯誤處理避免資訊洩露
- 實作適當的認證失敗處理

### API 端點結構
[Source: architecture/architecture-backend.md#函式組織結構]
```
apps/web/src/app/api/
├── auth/
│   ├── [...nextauth]/route.ts
│   └── session/route.ts
```

### 環境變數
[Source: architecture/architecture-project-structure.md#環境變數]
```env
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key
```

### 檔案位置
- 認證配置：`apps/web/src/lib/auth.ts`
- 使用者 Repository：`apps/web/src/repositories/userRepository.ts`
- API 路由：`apps/web/src/app/api/auth/`

### Parallel Development Considerations
- 此故事專注於後端認證 API，不影響前端開發
- 提供 RESTful API 介面供前端故事使用
- 與其他並行故事的 API 端點完全隔離 (/api/auth)

### Testing
[Source: architecture/architecture-standards.md#測試策略]
- **測試檔案位置**: apps/web/tests/integration/ (API 整合測試)
- **測試標準**: 整合測試驗證認證流程
- **測試框架**: Jest (API 測試)
- **此故事的特定測試要求**:
  - 測試登入 API 端點
  - 測試密碼驗證邏輯
  - 測試會話建立和管理
  - 測試錯誤處理和安全性

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.0 | 初始故事建立 - 並行開發第一組 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4

### Debug Log References
- All authentication components implemented with comprehensive error handling
- NextAuth.js 5.x configured with Credentials Provider
- Oracle database integration with connection pooling
- bcrypt password hashing with salt rounds of 12
- Comprehensive test suite created with Jest

### Completion Notes
- ✅ NextAuth.js 5.x configuration complete with JWT strategy
- ✅ User repository with Oracle database integration
- ✅ Password validation using bcrypt with proper salt rounds
- ✅ Role-based access control implementation
- ✅ API endpoints for authentication and session management
- ✅ Security measures: HTTPOnly cookies, CSRF protection, middleware
- ✅ Comprehensive test coverage for all authentication components
- ✅ Error handling standardized with custom error classes
- ✅ TypeScript type definitions for NextAuth extended

### File List
- `apps/web/package.json` - Project dependencies including NextAuth.js 5.x, bcrypt, oracledb
- `apps/web/src/lib/auth.ts` - NextAuth.js configuration with Credentials Provider
- `apps/web/src/repositories/userRepository.ts` - User data access layer with Oracle integration
- `apps/web/src/app/api/auth/[...nextauth]/route.ts` - NextAuth.js API route handler
- `apps/web/src/app/api/auth/session/route.ts` - Session validation endpoint
- `apps/web/src/types/next-auth.d.ts` - TypeScript type extensions for NextAuth
- `apps/web/src/lib/errors.ts` - Standardized error handling utilities
- `apps/web/src/middleware.ts` - Security middleware with headers and CSP
- `apps/web/.env.example` - Environment variables template
- `apps/web/tsconfig.json` - TypeScript configuration
- `apps/web/next.config.js` - Next.js configuration
- `apps/web/jest.config.js` - Jest testing configuration
- `apps/web/tests/setup.ts` - Test environment setup
- `apps/web/tests/integration/auth.test.ts` - Authentication unit tests
- `apps/web/tests/integration/auth-api.test.ts` - API endpoint tests

### Change Log
| Date | Action | File | Description |
|------|---------|------|-------------|
| 2025-09-09 | CREATE | auth.ts | NextAuth.js 5.x configuration with Credentials Provider |
| 2025-09-09 | CREATE | userRepository.ts | Oracle database user repository with bcrypt validation |
| 2025-09-09 | CREATE | [...nextauth]/route.ts | NextAuth.js API route handlers |
| 2025-09-09 | CREATE | session/route.ts | Session validation API endpoint |
| 2025-09-09 | CREATE | errors.ts | Standardized error handling system |
| 2025-09-09 | CREATE | middleware.ts | Security middleware with CSP and headers |
| 2025-09-09 | CREATE | Test files | Comprehensive test suite for authentication |

## QA Results

### Review Date: 2025-09-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Excellent** - This is a comprehensive, production-ready authentication system implementation. The code demonstrates strong adherence to security best practices, proper error handling, and maintainable architecture patterns. All acceptance criteria have been fully implemented with robust testing coverage.

### Refactoring Performed

- **File**: `apps/web/src/repositories/userRepository.ts`
  - **Change**: Standardized error handling to use DatabaseError with consistent error messages
  - **Why**: Prevents information leakage through inconsistent error messages
  - **How**: Replaced generic Error with DatabaseError and standardized messages

- **File**: `apps/web/src/lib/auth.ts`
  - **Change**: Added production JWT secret validation
  - **Why**: Ensures critical security configuration is present in production
  - **How**: Added runtime check that throws error if NEXTAUTH_SECRET missing in production

- **File**: `apps/web/src/app/api/auth/session/route.ts`
  - **Change**: Added basic rate limiting to session endpoint
  - **Why**: Prevents abuse and DoS attacks on session validation endpoint
  - **How**: Implemented simple in-memory rate limiting with 100 requests per 15-minute window

### Compliance Check

- Coding Standards: ✓ **PASS** - TypeScript best practices, clean architecture patterns
- Project Structure: ✓ **PASS** - Follows Next.js App Router structure, logical organization
- Testing Strategy: ✓ **PASS** - Comprehensive unit and integration tests with proper mocking
- All ACs Met: ✓ **PASS** - All 6 acceptance criteria fully implemented and validated

### Improvements Checklist

- [x] Standardized error handling to prevent information leakage (userRepository.ts)
- [x] Added production security validation for JWT secrets (auth.ts)
- [x] Implemented rate limiting on session endpoint (session/route.ts)
- [ ] Consider Redis-based rate limiting for production scale
- [ ] Add audit logging for security events (login attempts, failures)
- [ ] Consider database connection pooling configuration

### Security Review

**PASS** - Excellent security implementation:
- ✅ bcrypt password hashing with salt rounds 12 (exceeds minimum requirement of 10)
- ✅ HTTPOnly, Secure, SameSite cookie configuration
- ✅ Content Security Policy and security headers via middleware
- ✅ SQL injection protection through parameterized queries
- ✅ Standardized error messages prevent information disclosure
- ✅ JWT secret validation for production environments
- ✅ Rate limiting on sensitive endpoints

### Performance Considerations

**PASS** - Good performance practices:
- ✅ Efficient database connection management with proper cleanup
- ✅ Parameterized SQL queries for optimal execution plans
- ✅ JWT strategy for stateless session management
- ✅ Appropriate session timeout (30 days)
- ✅ Connection pooling via Oracle DB driver

### Requirements Traceability

All acceptance criteria mapped to implementation with comprehensive test coverage:

1. **NextAuth.js 認證配置** → `auth.ts` with Credentials Provider, JWT callbacks
2. **使用者驗證的 API 端點** → `[...nextauth]/route.ts`, `session/route.ts`
3. **Oracle 資料核對憑證** → `userRepository.findByUsername()` with parameterized queries
4. **安全會話建立** → JWT strategy with secure cookie configuration
5. **會話檢查和登出功能** → Session endpoint and NextAuth handlers
6. **錯誤處理和安全性措施** → Standardized error classes, middleware, rate limiting

### Files Modified During Review

- `apps/web/src/repositories/userRepository.ts` - Enhanced error handling
- `apps/web/src/lib/auth.ts` - Added production security validation  
- `apps/web/src/app/api/auth/session/route.ts` - Added rate limiting
- `docs/qa/gates/1.3-auth-backend-api.yml` - Created quality gate

### Gate Status

Gate: **PASS** → docs/qa/gates/1.3-auth-backend-api.yml
Quality Score: **95/100**

### Recommended Status

✓ **Ready for Done** - Implementation is complete, secure, and production-ready with comprehensive testing. All security hardening applied successfully.