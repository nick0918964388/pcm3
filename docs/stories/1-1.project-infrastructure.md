# Story 1-1: 專案基礎設施建置

## Story Details
- **Story ID**: 1-1  
- **Branch**: feature/story-1-1
- **Dependencies**: None (Foundation)
- **Parallel-safe**: ✅ True
- **Module**: Root project structure, Docker, Monorepo setup

## Status
Ready for Review

## Story
**As a** 開發者,
**I want** 設定一個新的 Next.js Monorepo 專案並配置好 Docker 基礎設施,
**so that** 整個團隊能擁有一個一致的本地開發環境與部署基礎

## Acceptance Criteria
1. Monorepo 專案結構被建立
2. Next.js 應用程式被初始化  
3. `docker-compose.yml` 建立並可成功啟動 Next.js 與 Oracle 服務
4. 基礎程式碼風格工具已配置
5. Git worktree 友善的專案結構已建立

## Tasks / Subtasks
- [x] 設定 Monorepo 專案結構 (AC: 1, 5)
  - [x] 建立根目錄 package.json 並配置 npm workspaces
  - [x] 建立 apps/web/ 目錄結構
  - [x] 建立 packages/shared/ 目錄結構  
  - [x] 建立 infrastructure/ 目錄
  - [x] 設定 Git worktree 友善的 .gitignore
- [x] 初始化 Next.js 應用程式 (AC: 2)
  - [x] 在 apps/web/ 中執行 create-next-app 建立 Next.js 14.x 專案
  - [x] 配置 TypeScript 5.x
  - [x] 整合 shadcn/ui 元件庫
  - [x] 設定 Tailwind CSS
- [x] 建立 Docker 容器化環境 (AC: 3)
  - [x] 建立 Dockerfile 使用 node:18-alpine 基底
  - [x] 建立 docker-compose.yml 包含 Next.js 與 Oracle 服務
  - [x] 配置環境變數範本 .env.example
  - [x] 驗證 Docker 環境可成功啟動
- [x] 配置開發工具 (AC: 4)
  - [x] 設定 ESLint 程式碼檢查
  - [x] 設定 Prettier 程式碼格式化
  - [x] 配置 Jest 測試框架基礎
  - [x] 設定 TypeScript 型別檢查

## Dev Notes

### Previous Story Insights
這是第一個基礎故事，沒有前一個故事的依賴。

### 技術堆疊要求
[Source: architecture/architecture-overview.md#技術堆疊]
- **前端框架**: Next.js 14.x
- **UI 元件庫**: shadcn/ui (Latest) 
- **語言**: TypeScript 5.x
- **部署**: Docker / Docker Compose (Latest)

### 專案結構規範
[Source: architecture/architecture-project-structure.md#統一專案結構]
```
/pcm-project/
├── apps/
│   └── web/                    # 核心 Next.js 應用程式
├── packages/                   # 共享套件
│   └── shared/                 # 共享的 TypeScript 型別
├── infrastructure/             # 基礎設施設定
├── scripts/                    # 工具腳本
├── docs/                       # 文件
├── .env.example
├── package.json                # Root package.json for monorepo
└── README.md
```

### Docker 配置規範
[Source: architecture/architecture-project-structure.md#Docker配置]
- 使用 node:18-alpine 作為基底映像
- 實作多階段建置 (multi-stage build)
- 包含 deps, builder, runner 階段

### 環境變數要求
[Source: architecture/architecture-project-structure.md#環境變數]
```env
DATABASE_URL=oracle://username:password@localhost:1521/xe
DATABASE_SCHEMA=PCM
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key
```

### Parallel Development Considerations
- 此故事影響根配置檔案，其他並行故事避免修改根目錄
- 建立的專案結構為後續並行開發提供隔離的模組空間
- Git worktree 設定確保分支間的最小衝突

### Testing
[Source: architecture/architecture-standards.md#測試策略]
- **測試檔案位置**: apps/web/__tests__/ (基礎設定測試)
- **測試框架**: Jest 基礎配置
- **此故事的特定測試要求**: 設定基礎測試配置，驗證 Docker 環境啟動

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.0 | 初始故事建立 - 並行開發第一組 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Completion Notes
- ✅ Successfully created complete monorepo structure with npm workspaces
- ✅ Implemented Next.js 14.x application with TypeScript 5.x
- ✅ Integrated shadcn/ui components with Tailwind CSS
- ✅ Configured Docker multi-stage build with node:18-alpine
- ✅ Set up docker-compose.yml with Next.js and Oracle services
- ✅ Created comprehensive development tooling (ESLint, Prettier, Jest)
- ✅ Established testing framework with infrastructure validation tests
- ✅ Generated project documentation and README

### File List
#### Created Files:
- `package.json` - Root monorepo configuration with npm workspaces
- `.gitignore` - Git worktree-friendly ignore patterns
- `README.md` - Comprehensive project documentation
- `jest.config.js` - Root Jest configuration for multi-project testing
- `docker-compose.yml` - Docker services configuration
- `.env.example` - Environment variables template

#### Apps/Web Directory:
- `apps/web/package.json` - Next.js app configuration
- `apps/web/next.config.js` - Next.js configuration with standalone output
- `apps/web/tsconfig.json` - TypeScript configuration with path mapping
- `apps/web/tailwind.config.ts` - Tailwind CSS configuration
- `apps/web/postcss.config.js` - PostCSS configuration
- `apps/web/Dockerfile` - Multi-stage Docker build configuration
- `apps/web/.eslintrc.json` - ESLint configuration
- `apps/web/.prettierrc` - Prettier configuration
- `apps/web/.prettierignore` - Prettier ignore patterns
- `apps/web/jest.config.js` - Jest configuration for web app
- `apps/web/jest.setup.js` - Jest setup with mocks
- `apps/web/app/layout.tsx` - Root layout component
- `apps/web/app/page.tsx` - Home page component
- `apps/web/app/globals.css` - Global styles with CSS variables
- `apps/web/components/ui/button.tsx` - Button component (shadcn/ui)
- `apps/web/lib/utils.ts` - Utility functions with cn helper

#### Packages/Shared Directory:
- `packages/shared/package.json` - Shared package configuration
- `packages/shared/src/index.ts` - Main export file
- `packages/shared/src/types/index.ts` - Shared TypeScript types
- `packages/shared/src/utils/index.ts` - Shared utility functions

#### Infrastructure Directory:
- `infrastructure/README.md` - Infrastructure documentation
- `infrastructure/oracle/init/01-create-user.sql` - Oracle user creation script

#### Test Files:
- `__tests__/docker-validation.test.js` - Docker configuration validation
- `apps/web/__tests__/setup.test.ts` - Basic setup validation
- `apps/web/__tests__/components/button.test.tsx` - Button component tests
- `apps/web/__tests__/page.test.tsx` - Home page tests

### Debug Log References
- No blocking issues encountered during implementation
- All validations passed successfully
- Docker configuration validated
- Monorepo structure validated

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.1 | Completed full infrastructure implementation | James (Dev Agent) |

## QA Results

### Review Date: 2025-09-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent infrastructure foundation with comprehensive monorepo setup, Docker containerization, and modern tooling. The implementation demonstrates solid understanding of enterprise development practices with proper separation of concerns and scalable architecture patterns.

### Refactoring Performed

- **File**: infrastructure/oracle/init/01-create-user.sql
  - **Change**: Removed excessive DBA privilege from PCM user
  - **Why**: DBA grants are unnecessary for application users and violate least privilege security principle
  - **How**: Changed from `GRANT CONNECT, RESOURCE, DBA` to `GRANT CONNECT, RESOURCE` only, maintaining required functionality while improving security posture

### Compliance Check

- Coding Standards: ✓ Excellent adherence to modern TypeScript/React patterns
- Project Structure: ✓ Perfect alignment with monorepo best practices  
- Testing Strategy: ✓ Strong foundation with Jest, infrastructure validation, and component testing
- All ACs Met: ✓ All 5 acceptance criteria fully implemented and validated

### Improvements Checklist

[✓ = Addressed during review, ☐ = Recommended for future consideration]

- [✓] Removed excessive DBA privileges from Oracle user (infrastructure/oracle/init/01-create-user.sql)
- [✓] Validated Docker configuration security (using non-root user, proper secrets handling)
- [✓] Confirmed proper TypeScript strict mode configuration
- [✓] Verified shadcn/ui integration follows best practices
- [✓] Validated monorepo workspace configuration
- [☐] Consider adding pre-commit hooks for code quality enforcement
- [☐] Add Dependabot configuration for automated dependency updates
- [☐] Implement Docker health checks for Next.js service (currently only Oracle has health check)
- [☐] Consider adding .dockerignore file to optimize Docker build context
- [☐] Add environment-specific docker-compose override files (dev/staging/prod)

### Security Review

**High Priority Issue Resolved:**
- ✅ **Fixed**: Removed DBA privileges from application database user (CRITICAL)

**Good Security Practices Identified:**
- ✅ Environment variables properly templated in .env.example
- ✅ Docker non-root user implementation (nextjs user)
- ✅ Secrets marked clearly as development-only defaults
- ✅ No hardcoded credentials in source code

**Security Recommendations:**
- Oracle password should use secrets management in production
- Consider implementing Docker secrets for production deployments
- Add rate limiting considerations for future API development

### Performance Considerations

**Optimizations Implemented:**
- ✅ Multi-stage Docker build reduces final image size
- ✅ Node.js 18 Alpine for minimal footprint
- ✅ Next.js standalone output configured for optimal production builds
- ✅ Proper volume mounting for development hot-reload

**Performance Notes:**
- Docker build optimization is excellent with proper layer caching
- TypeScript configuration optimized for development speed
- Tailwind CSS purging configured for production builds

### Files Modified During Review

- `infrastructure/oracle/init/01-create-user.sql` - Security enhancement (privilege reduction)

**Note to Dev**: Please update File List in Dev Agent Record to include this security fix.

### Gate Status

Gate: PASS → docs/qa/gates/1.1-project-infrastructure.yml
Risk profile: Low risk foundation story with security enhancement applied
NFR assessment: All non-functional requirements met with strong security posture

### Recommended Status

✓ **Ready for Done** - All requirements met, security enhanced, comprehensive infrastructure foundation established

*Exceptional work on project foundation. The monorepo structure, Docker configuration, and development tooling provide an excellent foundation for scalable development. Security enhancement applied proactively.*