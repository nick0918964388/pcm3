# Story 1.3a: 使用者認證後端 API

## Status
Draft

## Story
**As a** 系統開發者,
**I want** 實作使用者認證的後端 API 系統,
**so that** 前端可以安全地進行使用者驗證和會話管理

## Acceptance Criteria
1. 實作 NextAuth.js 認證配置
2. 建立使用者驗證的 API 端點
3. 根據 Oracle 中的資料核對憑證
4. 成功登入後建立安全會話
5. 提供會話檢查和登出功能
6. 實作適當的錯誤處理

## Tasks / Subtasks
- [ ] 設定 NextAuth.js 配置 (AC: 1)
  - [ ] 安裝 NextAuth.js 5.x
  - [ ] 建立 auth.ts 配置檔案
  - [ ] 配置 Credentials Provider
  - [ ] 設定會話策略和 JWT
- [ ] 實作使用者 Repository (AC: 3)
  - [ ] 建立 userRepository.ts
  - [ ] 實作 findByUsername 方法
  - [ ] 實作密碼驗證邏輯
  - [ ] 實作角色查詢功能
- [ ] 建立認證 API 端點 (AC: 2, 4, 5)
  - [ ] 建立 [...nextauth]/route.ts
  - [ ] 實作登入驗證邏輯
  - [ ] 實作會話管理
  - [ ] 建立 /api/auth/session 端點
- [ ] 實作安全性措施 (AC: 6)
  - [ ] 密碼雜湊驗證 (bcrypt)
  - [ ] 錯誤訊息標準化
  - [ ] 登入嘗試限制
  - [ ] 會話安全配置

## Dev Notes

### Previous Story Insights
依賴 Story 1.1 的專案結構和 Story 1.2 的資料庫連接。可與 Story 1.3b (前端登入頁面) 並行開發。

### 認證架構
[Source: architecture/architecture-backend.md#認證與授權架構]
使用 NextAuth.js 處理認證，並透過 Callbacks 將使用者角色資訊注入 Session Token。

### NextAuth.js 配置範例
[Source: architecture/architecture-backend.md#認證與授權架構]
```typescript
export const { handlers, auth, signIn, signOut } = NextAuth({
  providers: [
    CredentialsProvider({
      name: 'credentials',
      credentials: {
        username: { label: 'Username', type: 'text' },
        password: { label: 'Password', type: 'password' }
      },
      async authorize(credentials) {
        // 實作認證邏輯
      }
    })
  ],
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.username = user.username;
      }
      return token;
    },
    async session({ session, token }) {
      if (token) {
        session.user.id = token.sub;
        session.user.username = token.username;
      }
      return session;
    }
  }
});
```

### 使用者資料模型
[Source: architecture/architecture-data-models.md#資料庫結構]
USERS 表結構：
- id: NUMBER (主鍵)
- username: VARCHAR2(255) UNIQUE
- hashed_password: VARCHAR2(255)
- full_name: NVARCHAR2(255)
- email: VARCHAR2(255)
- created_at: TIMESTAMP

### Repository 模式實作
[Source: architecture/architecture-backend.md#資料存取層]
```typescript
export const userRepository = {
  async findByUsername(username: string): Promise<User | null> {
    // SQL 查詢實作
  },
  async validatePassword(plainPassword: string, hashedPassword: string): Promise<boolean> {
    // bcrypt 驗證
  }
};
```

### 安全性要求
[Source: architecture/architecture-standards.md#安全性需求]
- 使用 bcrypt 雜湊密碼，加鹽強度至少 10
- 使用 HTTPOnly、Secure、SameSite 屬性的 Session
- 實作 API 速率限制防止暴力破解
- 統一錯誤處理避免資訊洩露

### API 端點結構
[Source: architecture/architecture-backend.md#函式組織結構]
```
apps/web/src/app/api/
├── auth/
│   ├── [...nextauth]/route.ts
│   └── session/route.ts
```

### 環境變數
[Source: architecture/architecture-project-structure.md#環境變數]
```env
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key
```

### 檔案位置
- 認證配置：`apps/web/src/lib/auth.ts`
- 使用者 Repository：`apps/web/src/repositories/userRepository.ts`
- API 路由：`apps/web/src/app/api/auth/`

### Testing
[Source: architecture/architecture-standards.md#測試策略]
- **測試檔案位置**: apps/web/tests/integration/ (API 整合測試)
- **測試標準**: 整合測試驗證認證流程
- **測試框架**: Jest (API 測試)
- **此故事的特定測試要求**:
  - 測試登入 API 端點
  - 測試密碼驗證邏輯
  - 測試會話建立和管理
  - 測試錯誤處理和安全性

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.0 | 初始故事建立，從原 1.3 拆分後端部分 | Bob (Scrum Master) |

## Dev Agent Record
_This section will be populated by the development agent during implementation_

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_Results from QA Agent review will be populated here after implementation_