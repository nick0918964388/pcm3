# Story 5: 公告與通知系統

## Story Details
- **Story ID**: 5
- **Branch**: feature/story-5
- **Dependencies**: Story 4 (需要儀表板整合完成)
- **Parallel-safe**: ❌ False (依賴儀表板顯示)
- **Module**: Announcement management, notification display

## Status
Draft

## Story
**As a** 管理者,
**I want** 一個介面來發布與管理公告,
**so that** 我能傳達重要資訊並確保團隊成員及時收到通知

## Acceptance Criteria
1. 提供簡易編輯器來建立公告
2. 管理者可增刪改查公告
3. 公告儲存至資料庫
4. 支援公告優先級設定
5. 整合至儀表板顯示
6. 提供公告已讀狀態追蹤
7. 支援公告定時發布功能

## Tasks / Subtasks
- [ ] 建立公告管理 API (AC: 2, 3)
  - [ ] 建立 announcementRepository.ts
  - [ ] 建立 /api/announcements 端點
  - [ ] 實作公告 CRUD 操作
  - [ ] 實作公告狀態管理
- [ ] 建立公告編輯前端 (AC: 1)
  - [ ] 整合富文本編輯器 (如 TinyMCE 或 Quill)
  - [ ] 建立公告建立表單
  - [ ] 實作圖片上傳支援
  - [ ] 建立公告預覽功能
- [ ] 實作公告管理功能 (AC: 2, 4)
  - [ ] 建立公告列表管理介面
  - [ ] 實作公告優先級設定
  - [ ] 建立公告編輯和刪除功能
  - [ ] 實作公告搜尋和篩選
- [ ] 整合儀表板顯示 (AC: 5)
  - [ ] 建立公告顯示元件
  - [ ] 實作最新公告排序
  - [ ] 建立公告詳細檢視
  - [ ] 實作公告摺疊/展開
- [ ] 實作已讀狀態追蹤 (AC: 6)
  - [ ] 建立已讀狀態資料表
  - [ ] 實作已讀狀態 API
  - [ ] 建立已讀標記功能
  - [ ] 實作已讀統計顯示
- [ ] 建立定時發布功能 (AC: 7)
  - [ ] 實作公告排程邏輯
  - [ ] 建立定時發布介面
  - [ ] 實作自動發布任務
  - [ ] 建立發布狀態追蹤

## Dev Notes

### Previous Story Insights
依賴 Story 4 的儀表板整合，公告需要在儀表板上顯示。整合到現有的角色化儀表板系統中。

### 公告資料模型
[Source: architecture/architecture-data-models.md#資料庫結構]
```sql
CREATE TABLE ANNOUNCEMENTS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    project_id NUMBER,
    title NVARCHAR2(255) NOT NULL,
    content CLOB NOT NULL,
    created_by NUMBER NOT NULL,
    is_active NUMBER(1) DEFAULT 1,
    priority VARCHAR2(20) DEFAULT 'normal',
    scheduled_at TIMESTAMP,
    published_at TIMESTAMP,
    expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES PROJECTS(id),
    FOREIGN KEY (created_by) REFERENCES USERS(id)
);
```

### 已讀狀態追蹤模型
```sql
CREATE TABLE ANNOUNCEMENT_READS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    announcement_id NUMBER NOT NULL,
    user_id NUMBER NOT NULL,
    read_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (announcement_id) REFERENCES ANNOUNCEMENTS(id),
    FOREIGN KEY (user_id) REFERENCES USERS(id),
    UNIQUE(announcement_id, user_id)
);
```

### API 端點設計
[Source: architecture/architecture-api-spec.md#公告API]
- `GET /api/announcements` - 取得公告列表
- `POST /api/announcements` - 建立新公告
- `PUT /api/announcements/{id}` - 更新公告
- `DELETE /api/announcements/{id}` - 刪除公告
- `POST /api/announcements/{id}/read` - 標記已讀
- `GET /api/announcements/{id}/stats` - 取得已讀統計

### 富文本編輯器整合
使用 TinyMCE 或 Quill 編輯器：
```typescript
interface AnnouncementEditorProps {
  initialContent?: string;
  onChange: (content: string) => void;
  onImageUpload: (file: File) => Promise<string>;
}

const AnnouncementEditor: React.FC<AnnouncementEditorProps> = ({
  initialContent,
  onChange,
  onImageUpload
}) => {
  // 富文本編輯器邏輯
};
```

### 公告優先級設計
- **high**: 緊急公告，紅色標示，置頂顯示
- **normal**: 一般公告，預設樣式
- **low**: 低優先級公告，灰色標示

### 儀表板整合設計
在 Story 4 的儀表板基礎上整合：
- 最新公告區塊
- 未讀公告提醒
- 公告快速檢視
- 公告詳細頁面連結

### 定時發布功能
- 支援未來時間排程
- 自動發布任務
- 發布狀態通知
- 排程修改和取消

### 已讀狀態追蹤
- 自動標記已讀
- 已讀統計顯示
- 未讀提醒功能
- 已讀用戶列表

### 檔案位置
- 公告 Repository：`apps/web/src/repositories/announcementRepository.ts`
- 公告 API：`apps/web/src/app/api/announcements/`
- 公告管理頁面：`apps/web/src/app/(main)/[projectId]/announcements/`
- 公告元件：`apps/web/src/components/features/announcements/`
- 儀表板公告元件：`apps/web/src/components/features/dashboard/AnnouncementWidget.tsx`

### Sequential Development Considerations
- 必須等待 Story 4 儀表板完成
- 整合到現有儀表板架構
- 不影響其他儀表板功能
- 提供獨立的公告管理介面

### Testing
[Source: architecture/architecture-standards.md#測試策略]
- **測試檔案位置**: 
  - apps/web/tests/integration/ (API 測試)
  - apps/web/__tests__/components/ (元件測試)
  - apps/web/tests/e2e/ (公告流程 E2E 測試)
- **測試標準**: API 整合測試 + React 元件測試 + E2E 測試
- **測試框架**: Jest + React Testing Library + Playwright
- **此故事的特定測試要求**:
  - 測試公告管理 API 端點
  - 測試富文本編輯器功能
  - 測試儀表板公告顯示
  - 測試已讀狀態追蹤
  - E2E 測試公告發布到顯示流程

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.0 | 初始故事建立 - 序列開發 | Bob (Scrum Master) |

## Dev Agent Record
_This section will be populated by the development agent during implementation_

## QA Results
_Results from QA Agent review will be populated here after implementation_